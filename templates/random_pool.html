<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšæœºæ± ç®¡ç†</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <script>
        // ç«‹å³è®¾ç½®æ·±è‰²ä¸»é¢˜ï¼Œé¿å…é¡µé¢åŠ è½½é—ªçƒ
        (function() {
            const storedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            // é»˜è®¤ä½¿ç”¨æ·±è‰²æ¨¡å¼ï¼Œé™¤éç”¨æˆ·æ˜ç¡®é€‰æ‹©äº†æµ…è‰²
            if (storedTheme === 'light') {
                document.documentElement.removeAttribute('data-theme');
            } else if (storedTheme === 'dark' || (!storedTheme && systemDark)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
            // å¦‚æœæ²¡æœ‰å­˜å‚¨ä¸»é¢˜ä¸”ç³»ç»Ÿæ˜¯æµ…è‰²ï¼Œä¿æŒé»˜è®¤ï¼ˆæµ…è‰²ï¼‰
        })();
    </script>
    <script src="/static/dark-mode.js"></script>
    <script src="/static/review_modal.js"></script>
    <style>
        body { background-color: var(--bg-primary); }
        .container { max-width: 900px; margin: 30px auto; background-color: var(--bg-secondary); border-radius: 18px; box-shadow: 0 4px 24px var(--shadow-color); padding: 32px 24px; }
        h1 { text-align: center; margin-bottom: 1.5em; letter-spacing: 2px; color: var(--header-color); }
        .create-pool-area { background-color: var(--card-bg); border-radius: 12px; padding: 18px 20px 14px 20px; margin-bottom: 2em; box-shadow: 0 2px 8px var(--shadow-color); border: 1px solid var(--border-color); }
        .create-pool-area h2 { margin-top: 0; font-size: 1.15em; color: var(--header-color); }
        .create-pool-area input, .create-pool-area select, .create-pool-area textarea {
            border: 1px solid var(--border-color); border-radius: 7px; padding: 6px 10px; margin: 4px 6px 8px 0; font-size: 1em; transition: border 0.2s; outline: none; background-color: var(--input-bg); color: var(--text-primary);
        }
        .create-pool-area input:focus, .create-pool-area select:focus, .create-pool-area textarea:focus {
            border: 1.5px solid var(--accent-color);
        }
        .create-pool-area button {
            background: linear-gradient(90deg, var(--accent-color) 0%, var(--accent-hover) 100%); color: var(--text-primary); border: none; border-radius: 7px; padding: 7px 22px; font-size: 1em; cursor: pointer; box-shadow: 0 2px 8px var(--shadow-color); transition: background 0.2s, box-shadow 0.2s;
        }
        .create-pool-area button:hover {
            background: linear-gradient(90deg, var(--accent-hover) 0%, var(--accent-color) 100%); box-shadow: 0 4px 16px var(--shadow-color);
        }
        .pool-list { margin-top: 2em; }
        .pool-card {
            border: 1.5px solid var(--border-color); border-radius: 16px; padding: 1.2em 1.5em; margin-bottom: 2em;
            background-color: var(--card-bg); box-shadow: 0 4px 18px rgba(76,140,255,0.07), 0 1.5px 0 var(--border-color);
            transition: box-shadow 0.2s, border 0.2s;
        }
        .pool-card:hover {
            box-shadow: 0 8px 32px rgba(76,140,255,0.13), 0 2px 0 var(--border-color);
            border: 1.5px solid var(--accent-color);
        }
        .pool-title { font-weight: bold; font-size: 1.18em; color: var(--header-color); margin-bottom: 0.2em; }
        .filter-desc { color: var(--text-secondary); font-size: 0.98em; margin-bottom: 0.5em; }
        .pool-table-area { overflow-x: auto; }
        .pool-table {
            width: 100%; border-collapse: separate; border-spacing: 0; background-color: var(--bg-secondary); border-radius: 10px; overflow: hidden;
            box-shadow: 0 2px 8px rgba(76,140,255,0.04);
        }
        .pool-table th, .pool-table td {
            padding: 8px 10px; text-align: center; font-size: 1em; color: var(--text-primary);
        }
        .pool-table th {
            background-color: var(--table-header-bg); color: var(--header-color); font-weight: 600; border-bottom: 2px solid var(--border-color);
        }
        .pool-table tr {
            transition: background 0.18s;
        }
        .pool-table tr:hover {
            background-color: var(--table-hover);
        }
        .completion-cell, .favorite-cell, .review-cell {
            cursor: pointer; border-radius: 6px; transition: background 0.18s, color 0.18s;
        }
        .completion-cell:hover {
            background: var(--table-hover); color: var(--accent-color);
        }
        .favorite-cell {
            font-size: 1.25em; transition: color 0.18s;
        }
        .favorite-cell:hover {
            color: var(--accent-color);
        }
        .review-cell {
            font-size: 1.2em; transition: color 0.18s;
        }
        .review-cell:hover {
            color: var(--accent-color);
        }
        .pool-actions { margin-top: 0.7em; }
        .pool-actions button {
            background: linear-gradient(90deg, var(--accent-color) 0%, var(--accent-hover) 100%); color: white; border: none; border-radius: 7px; padding: 7px 18px; font-size: 1em; cursor: pointer; margin-right: 10px; box-shadow: 0 2px 8px rgba(76,140,255,0.08); transition: background 0.2s, box-shadow 0.2s;
        }
        .pool-actions button:hover {
            background: linear-gradient(90deg, var(--accent-hover) 0%, var(--accent-color) 100%); box-shadow: 0 4px 16px var(--shadow-color);
        }
        .toast {
            position: fixed; left: 50%; top: 10%; transform: translateX(-50%); background-color: var(--card-bg); color: var(--text-primary); padding: 10px 28px; border-radius: 8px; font-size: 1.08em; opacity: 0; pointer-events: none; z-index: 9999; transition: opacity 0.3s, top 0.3s; border: 1px solid var(--border-color);
        }
        .toast.show { opacity: 1; top: 5%; pointer-events: auto; }
        
        .random-info-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-secondary);
            border: 2px solid var(--accent-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px var(--shadow-color);
            z-index: 1000;
            min-width: 250px;
            text-align: center;
        }
        
        .score-code-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .score-code {
            font-size: 1.5em;
            color: var(--text-primary);
        }
        
        .favorite-icon {
            font-size: 1.8em;
            color: var(--accent-color);
            transition: color 0.2s;
        }
        
        .completion-row {
            font-size: 1.1em;
            color: var(--text-secondary);
        }
        
        .completion-badge {
            background: linear-gradient(90deg, var(--accent-color) 0%, var(--accent-hover) 100%);
            color: var(--text-primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>éšæœºæ± ç®¡ç†</h1>
        <div class="create-pool-area">
            <h2>åˆ›å»ºæ–°éšæœºæ± </h2>
            <input type="text" id="poolName" placeholder="æ± å" style="width: 200px;">
            <input type="number" id="minCompletion" placeholder="æœ€å°å®Œæˆç‡" min="0" max="100" style="width: 120px;">
            <input type="number" id="maxCompletion" placeholder="æœ€å¤§å®Œæˆç‡" min="0" max="100" style="width: 120px;">
            <select id="favorite">
                <option value="">æ”¶è—ç­›é€‰</option>
                <option value="1">ä»…æ”¶è—</option>
                <option value="2">ä»…æœªæ”¶è—</option>
            </select>
            <br><textarea id="customCodes" placeholder="å¯è‡ªå®šä¹‰æ± å†…å®¹ï¼ˆæ¯è¡Œä¸€ä¸ªæ›²è°±ç ï¼Œä¼˜å…ˆäºç­›é€‰ç»“æœï¼‰" style="width: 90%; height: 60px; margin-top: 8px;"></textarea>
            <button id="createPoolBtn">åˆ›å»ºæ± </button>
        </div>
        <div class="pool-list" id="poolList"></div>
        <div id="randomCopyInfo" style="margin-top: 18px;"></div>
    </div>

    <!-- è¯„ä»·å¼¹çª— -->
    <div id="reviewModal" class="qyj-modal" aria-hidden="true">
      <div class="qyj-modal__backdrop" data-close-modal></div>
      <div class="qyj-modal__card" role="dialog" aria-modal="true" aria-labelledby="reviewTitle">
        <div class="qyj-modal__header">
          <h3 id="reviewTitle">æ·»åŠ è¯„ä»·</h3>
          <button class="qyj-modal__close" id="reviewCloseBtn" aria-label="å…³é—­">âœ•</button>
        </div>

        <div class="qyj-field">
          <label class="qyj-label">æ‰“åˆ†</label>
          <div id="starGroup" class="qyj-stars" role="radiogroup" aria-label="å–œæ¬¢ç¨‹åº¦ 1 åˆ° 5 æ˜Ÿ">
            <button type="button" class="qyj-star" data-val="1" aria-checked="false" role="radio">â˜†</button>
            <button type="button" class="qyj-star" data-val="2" aria-checked="false" role="radio">â˜†</button>
            <button type="button" class="qyj-star" data-val="3" aria-checked="false" role="radio">â˜†</button>
            <button type="button" class="qyj-star" data-val="4" aria-checked="false" role="radio">â˜†</button>
            <button type="button" class="qyj-star" data-val="5" aria-checked="true" role="radio">â˜†</button>
            <input type="hidden" id="reviewRating" value="5">
          </div>
        </div>

        <div class="qyj-field">
          <label class="qyj-label" for="reviewComment">è¯„è¯­ï¼ˆä¸ºä»€ä¹ˆå–œæ¬¢ï¼Ÿï¼‰ *</label>
          <textarea id="reviewComment" rows="4" class="qyj-textarea" placeholder="è¿™ä¸€æ®µæœ€æ‰“åŠ¨æˆ‘çš„æ˜¯â€¦" required></textarea>
        </div>

        <div class="qyj-field" id="reviewVideoSourceField">
          <label class="qyj-label">è§†é¢‘æ¥æº *</label>
          <div class="qyj-radio-group" id="reviewVideoSourceGroup">
            <label class="qyj-radio">
              <input type="radio" name="reviewVideoSource" value="upload" checked>
              ä¸Šä¼ è§†é¢‘æ–‡ä»¶
            </label>
            <label class="qyj-radio">
              <input type="radio" name="reviewVideoSource" value="external">
              ä½¿ç”¨è§†é¢‘é“¾æ¥ / Bç«™åµŒå…¥ä»£ç 
            </label>
          </div>
        </div>

        <div class="qyj-field" id="reviewFileRow">
          <label class="qyj-label" for="reviewVideo">ä¸Šä¼ å®å½•è§†é¢‘ *</label>
          <label class="qyj-file">
            <input type="file" id="reviewVideo" accept=".mp4,.mov,.m4v,.webm,.avi,.mkv">
            <span class="qyj-file__btn">é€‰æ‹©æ–‡ä»¶</span>
            <span class="qyj-file__name" id="videoFileName">æœªé€‰æ‹©æ–‡ä»¶</span>
          </label>
          <div class="qyj-tip-sm">æ”¯æŒ mp4 / mov / webm / avi / mkvï¼›æ–‡ä»¶è¾ƒå¤§ä¼šèŠ±æ›´ä¹…æ—¶é—´ã€‚</div>
        </div>

        <div class="qyj-field" id="reviewUrlRow" style="display:none;">
          <div class="qyj-tip-sm">
            <a class="qyj-link-btn" href="https://member.bilibili.com/platform/upload/video/frame" target="_blank" rel="noopener noreferrer">
              <span class="qyj-link-btn__icon">ğŸ“¤</span>
              <span>è·³è½¬æŠ•ç¨¿</span>
            </a>
          </div>
          <label class="qyj-label" for="reviewVideoUrl">è§†é¢‘é“¾æ¥æˆ–åµŒå…¥ä»£ç  *</label>
          <textarea id="reviewVideoUrl" rows="3" class="qyj-textarea" placeholder="ä¾‹å¦‚ https://example.com/video.mp4 æˆ–ç²˜è´´ Bç«™åµŒå…¥ä»£ç "></textarea>
          <div class="qyj-tip-sm">æ”¯æŒ http(s) è§†é¢‘é“¾æ¥ï¼Œæˆ–ç²˜è´´ Bç«™â€œåˆ†äº« â†’ åµŒå…¥ä»£ç â€ä¸­çš„ iframeã€‚</div>
        </div>

        <div class="qyj-field" id="reviewPreviewRow" style="display:none;">
          <label class="qyj-label">è§†é¢‘é¢„è§ˆ</label>
          <video id="reviewVideoPreview" controls style="width:100%; border-radius:10px; outline: none; display:none;"></video>
          <div id="reviewEmbedPreview" class="review-embed" style="display:none;"></div>
        </div>

        <div class="qyj-tip">
          æç¤ºï¼šè¿™æ˜¯å¯¹ä¸€ä¸ªè°±å­çš„æœ€é«˜è¯„ä»·ã€‚<br>
          å¸¦ * å·çš„ä¸ºå¿…å¡«é¡¹ï¼šè¯„è¯­å¿…é¡»å¡«å†™ï¼Œè§†é¢‘å¯é€‰æ‹©ä¸Šä¼ æ–‡ä»¶æˆ–æä¾›å¤–éƒ¨é“¾æ¥ / Bç«™åµŒå…¥ä»£ç ã€‚
        </div>

        <div class="qyj-modal__actions">
          <button id="reviewCancelBtn" class="qyj-btn qyj-btn--ghost">å–æ¶ˆ</button>
          <button id="reviewSubmitBtn" class="qyj-btn qyj-btn--primary">ä¿å­˜è¯„ä»·</button>
        </div>
        <div id="reviewMsg" class="qyj-msg" aria-live="polite"></div>
      </div>
    </div>

    <script>
    const reviewModalInstance = new ReviewModal();
    if (!reviewModalInstance.isReady()) {
        console.warn('ReviewModal: éšæœºæ± é¡µå¼¹çª—åˆå§‹åŒ–å¤±è´¥');
    }

    // è¾…åŠ©å‡½æ•°
    function filterDesc(filter) {
        let arr = [];
        if (filter.min_completion !== undefined && filter.min_completion !== null) arr.push('æœ€å°å®Œæˆç‡:' + filter.min_completion);
        if (filter.max_completion !== undefined && filter.max_completion !== null) arr.push('æœ€å¤§å®Œæˆç‡:' + filter.max_completion);
        if (filter.favorite === 1) arr.push('ä»…æ”¶è—');
        if (filter.favorite === 2) arr.push('ä»…æœªæ”¶è—');
        return arr.length ? arr.join('ï¼Œ') : 'æ— ';
    }

    // è‡ªåŠ¨æ£€æµ‹localStorageå¹¶é¢„å¡«
    window.addEventListener('DOMContentLoaded', function() {
        const filterStr = localStorage.getItem('batch_pool_filter');
        const codesStr = localStorage.getItem('batch_pool_codes');
        if (filterStr) {
            try {
                const filter = JSON.parse(filterStr);
                if (filter.min_completion !== undefined) document.getElementById('minCompletion').value = filter.min_completion;
                if (filter.max_completion !== undefined) document.getElementById('maxCompletion').value = filter.max_completion;
                if (filter.favorite !== undefined) document.getElementById('favorite').value = filter.favorite;
            } catch(e) {}
        }
        if (codesStr) {
            try {
                const codes = JSON.parse(codesStr);
                document.getElementById('customCodes').value = codes.join('\n');
            } catch(e) {}
        }
        // è‡ªåŠ¨ç”Ÿæˆæ± å
        if (filterStr || codesStr) {
            const now = new Date();
            const pad = n => n.toString().padStart(2, '0');
            document.getElementById('poolName').value = 'æ‰¹é‡æ± _' + now.getFullYear() + pad(now.getMonth()+1) + pad(now.getDate()) + '_' + pad(now.getHours()) + pad(now.getMinutes());
        }
        // æ¸…ç†localStorage
        localStorage.removeItem('batch_pool_filter');
        localStorage.removeItem('batch_pool_codes');
    });

    // åˆ›å»ºæ± 
    document.getElementById('createPoolBtn').onclick = async function() {
        const name = document.getElementById('poolName').value.trim();
        const minCompletion = document.getElementById('minCompletion').value;
        const maxCompletion = document.getElementById('maxCompletion').value;
        const favorite = document.getElementById('favorite').value;
        const customCodes = document.getElementById('customCodes').value.trim();
        if (!name) { alert('æ± åä¸èƒ½ä¸ºç©º'); return; }
        let filter = {};
        if (minCompletion) filter.min_completion = parseInt(minCompletion);
        if (maxCompletion) filter.max_completion = parseInt(maxCompletion);
        if (favorite) filter.favorite = parseInt(favorite);
        // å¦‚æœæ‰€æœ‰ç­›é€‰éƒ½ä¸ºç©ºï¼Œåˆ™filterè®¾ä¸º{}ï¼Œå¦åˆ™ä¼ é€’å®é™…ç­›é€‰
        if (!minCompletion && !maxCompletion && !favorite) filter = {};
        let body = { name, filter };
        if (customCodes) {
            // åªä¿ç•™åˆæ³•æ›²è°±ç 
            const codes = customCodes.split(/\r?\n/).map(s=>s.trim()).filter(s=>/^\d{5,}$/.test(s));
            if (codes.length === 0) { alert('è‡ªå®šä¹‰æ± å†…å®¹æ— æœ‰æ•ˆæ›²è°±ç '); return; }
            body.codes = codes;
        }
        const resp = await fetch('/api/random_pool/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await resp.json();
        if (data.success) {
            alert('åˆ›å»ºæˆåŠŸ');
            loadPools();
        } else {
            alert('åˆ›å»ºå¤±è´¥ï¼š' + data.error);
        }
    };

    // åŠ è½½æ± åˆ—è¡¨
    async function loadPools() {
        const resp = await fetch('/api/random_pool/list');
        const data = await resp.json();
        if (!data.success) { document.getElementById('poolList').innerHTML = 'åŠ è½½å¤±è´¥'; return; }
        const pools = data.pools;
        let html = '';
        for (const pool of pools) {
            html += `<div class="pool-card" data-pool-id="${pool.id}">
                <div class="pool-title">${pool.name} <span style="font-size:0.9em;color:var(--text-muted);">(${pool.codes.length}ä¸ª)</span></div>
                <div class="filter-desc">ç­›é€‰æ¡ä»¶ï¼š${filterDesc(pool.filter)}</div>
                <div class="secondary-filter" style="margin-bottom:10px;display:flex;align-items:center;gap:10px;">
                    <input type="number" class="sec-min-completion" placeholder="æœ€å°å®Œæˆç‡" min="0" max="100" style="width:90px;">
                    <span>-</span>
                    <input type="number" class="sec-max-completion" placeholder="æœ€å¤§å®Œæˆç‡" min="0" max="100" style="width:90px;">
                    <select class="sec-favorite" style="width:100px;">
                        <option value="">æ”¶è—ç­›é€‰</option>
                        <option value="1">ä»…æ”¶è—</option>
                        <option value="2">ä»…æœªæ”¶è—</option>
                    </select>
                    <button class="sec-apply-btn" style="padding:4px 16px;">åº”ç”¨</button>
                </div>
                <div class="pool-table-area">
                    <table class="pool-table" style="width:100%;margin:8px 0;">
                        <thead><tr>
                            <th>æ›²è°±ç </th>
                            <th class="completion-header" style="position:relative;cursor:pointer;z-index:1002;">
                                å®Œæˆç‡
                                <div class="completion-filter" style="display:none;position:absolute;top:100%;left:50%;transform:translateX(-50%);z-index:9999;background:var(--bg-secondary);padding:10px;border:1px solid var(--border-color);border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.1);min-width:120px;">
                                    <div class="range-inputs" style="display:flex;align-items:center;gap:8px;">
                                        <input type="number" class="header-min-completion" placeholder="æœ€å°" min="0" max="100" style="width:60px;">
                                        <span class="range-separator">-</span>
                                        <input type="number" class="header-max-completion" placeholder="æœ€å¤§" min="0" max="100" style="width:60px;">
                                    </div>
                                    <button class="header-apply-completion" style="margin-top:8px;width:100%;padding:4px 0;">åº”ç”¨</button>
                                </div>
                            </th>
                            <th class="favorite-header" style="position:relative;cursor:pointer;z-index:1002;">
                                æ”¶è—
                                <div class="favorite-filter" style="display:none;position:absolute;top:100%;left:50%;transform:translateX(-50%);z-index:9999;background:var(--bg-secondary);padding:10px;border:1px solid var(--border-color);border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.1);min-width:100px;">
                                    <button class="header-fav-btn" data-fav="">å…¨éƒ¨</button>
                                    <button class="header-fav-btn" data-fav="1">ä»…æ”¶è—</button>
                                    <button class="header-fav-btn" data-fav="2">ä»…æœªæ”¶è—</button>
                                </div>
                            </th>
                            <th>è¯„ä»·</th>
                        </tr></thead>
                        <tbody>
                            ${pool.codes.map(code => `
                                <tr data-code="${code}">
                                    <td>${code}</td>
                                    <td class="completion-cell" data-code="${code}">-</td>
                                    <td class="favorite-cell" data-code="${code}">-</td>
                                    <td class="review-cell" data-code="${code}">ğŸ©¶</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="pool-actions">
                    <button class="random-copy-btn" style="background: linear-gradient(145deg, var(--accent-color), var(--accent-hover)); margin-right: 18px;" onclick="randomCopyFromPool(${pool.id})">éšæœºå¤åˆ¶</button>
                    <button class="delete-pool-btn" style="background: linear-gradient(145deg, var(--accent-hover), var(--accent-color));" onclick="deletePool(${pool.id})">åˆ é™¤æ± </button>
                    <button class="query-btn" style="background:linear-gradient(145deg,var(--accent-color),var(--accent-hover));margin-right:8px;" onclick="queryOrExcludePool(${pool.id},'query', this)">æŸ¥è¯¢</button>
                    <button class="exclude-btn" style="background:linear-gradient(145deg,var(--accent-hover),var(--accent-color));margin-right:8px;" onclick="queryOrExcludePool(${pool.id},'exclude', this)">æ’é™¤</button>
                    <button class="reset-pool-btn" style="background:linear-gradient(145deg,var(--accent-color),var(--accent-hover));margin-right:0;" onclick="resetPool(${pool.id}, this)">é‡ç½®æ± </button>
                </div>
            </div>`;
        }
        document.getElementById('poolList').innerHTML = html || '<div>æš‚æ— éšæœºæ± </div>';
        // åŠ è½½æ¯ä¸ªæ± çš„æ›²è°±ç è¯¦æƒ…
        for (const pool of pools) {
            if (!pool.codes.length) continue;
            // æ‰¹é‡æŸ¥è¯¦æƒ…
            const resp = await fetch('/api/scores/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ score_codes: pool.codes })
            });
            const data = await resp.json();
            if (!data.success) continue;
            for (const r of data.results) {
                // å®Œæˆç‡
                const cell = document.querySelector(`.pool-card [data-code='${r.score_code}'].completion-cell`);
                if (cell) {
                    cell.textContent = r.completion !== null ? r.completion + '%' : '-';
                    cell.style.cursor = 'default';
                    cell.onclick = null;
                }
                // æ”¶è—
                const favCell = document.querySelector(`.pool-card [data-code='${r.score_code}'].favorite-cell`);
                if (favCell) {
                    favCell.textContent = r.is_favorite ? 'â˜…' : 'â˜†';
                    favCell.style.cursor = 'default';
                    favCell.onclick = null;
                }
                // è¯„ä»·
                const reviewCell = document.querySelector(`.pool-card [data-code='${r.score_code}'].review-cell`);
                if (reviewCell) {
                    let hasReview = !!r.has_review;
                    const refreshHeart = () => {
                        reviewCell.textContent = hasReview ? 'â¤ï¸' : 'ğŸ©¶';
                        reviewCell.title = hasReview ? 'æŸ¥çœ‹è¯„ä»·' : 'æ·»åŠ è¯„ä»·';
                    };
                    refreshHeart();
                    reviewCell.style.cursor = reviewModalInstance.isReady() ? 'pointer' : 'not-allowed';
                    reviewCell.onclick = async () => {
                        if (!reviewModalInstance.isReady()) {
                            showToast('è¯„ä»·å¼¹çª—æœªåˆå§‹åŒ–');
                            return;
                        }
                        const preferredMode = hasReview ? 'view' : 'create';
                        const { mode } = await reviewModalInstance.open({
                            scoreCode: r.score_code,
                            mode: preferredMode,
                            onSaved: () => {
                                hasReview = true;
                                refreshHeart();
                                loadPools();
                            }
                        });
                        if (mode === 'view') {
                            hasReview = true;
                            refreshHeart();
                        } else if (preferredMode === 'view' && mode === 'create') {
                            hasReview = false;
                            refreshHeart();
                        }
                    };
                }
            }
        }
        // ç»‘å®šäºŒæ¬¡ç­›é€‰äº‹ä»¶
        document.querySelectorAll('.pool-card').forEach(card => {
            const poolId = card.getAttribute('data-pool-id');
            const minInput = card.querySelector('.sec-min-completion');
            const maxInput = card.querySelector('.sec-max-completion');
            const favSel = card.querySelector('.sec-favorite');
            const applyBtn = card.querySelector('.sec-apply-btn');
            applyBtn.onclick = async function() {
                applyBtn.disabled = true;
                const min = minInput.value;
                const max = maxInput.value;
                const fav = favSel.value;
                const filter = {};
                if (min) filter.min_completion = parseInt(min);
                if (max) filter.max_completion = parseInt(max);
                if (fav) filter.favorite = parseInt(fav);
                const resp = await fetch(`/api/random_pool/${poolId}/filter`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filter })
                });
                const data = await resp.json();
                if (data.success) {
                    await loadPools();
                    showToast('ç­›é€‰å®Œæˆ');
                } else {
                    showToast('ç­›é€‰å¤±è´¥ï¼š' + data.error);
                }
                applyBtn.disabled = false;
            };
            // å®Œæˆç‡ç­›é€‰
            const completionHeader = card.querySelector('.completion-header');
            const completionFilter = card.querySelector('.completion-filter');
            if (completionHeader && completionFilter) {
                let compFilterVisible = false;
                completionHeader.onclick = (e) => {
                    compFilterVisible = true;
                    completionFilter.style.display = 'block';
                };
                document.addEventListener('mousedown', function hideCompFilter(e) {
                    if (!compFilterVisible) return;
                    if (!completionFilter.contains(e.target) && e.target !== completionHeader) {
                        completionFilter.style.display = 'none';
                        compFilterVisible = false;
                    }
                });
                completionFilter.querySelector('.header-apply-completion').onclick = async function() {
                    const min = completionFilter.querySelector('.header-min-completion').value;
                    const max = completionFilter.querySelector('.header-max-completion').value;
                    const filter = {};
                    if (min) filter.min_completion = parseInt(min);
                    if (max) filter.max_completion = parseInt(max);
                    const resp = await fetch(`/api/random_pool/${poolId}/filter`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filter })
                    });
                    const data = await resp.json();
                    if (data.success) {
                        await loadPools();
                    } else {
                        showToast('ç­›é€‰å¤±è´¥ï¼š' + data.error);
                    }
                    completionFilter.style.display = 'none';
                    compFilterVisible = false;
                };
            }
            // æ”¶è—ç­›é€‰
            const favoriteHeader = card.querySelector('.favorite-header');
            const favoriteFilter = card.querySelector('.favorite-filter');
            if (favoriteHeader && favoriteFilter) {
                let favFilterVisible = false;
                favoriteHeader.onclick = (e) => {
                    favFilterVisible = true;
                    favoriteFilter.style.display = 'block';
                };
                document.addEventListener('mousedown', function hideFavFilter(e) {
                    if (!favFilterVisible) return;
                    if (!favoriteFilter.contains(e.target) && e.target !== favoriteHeader) {
                        favoriteFilter.style.display = 'none';
                        favFilterVisible = false;
                    }
                });
                favoriteFilter.querySelectorAll('.header-fav-btn').forEach(btn => {
                    btn.onclick = async function() {
                        const fav = btn.getAttribute('data-fav');
                        const filter = {};
                        if (fav) filter.favorite = parseInt(fav);
                        const resp = await fetch(`/api/random_pool/${poolId}/filter`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filter })
                        });
                        const data = await resp.json();
                        if (data.success) {
                            await loadPools();
                        } else {
                            showToast('ç­›é€‰å¤±è´¥ï¼š' + data.error);
                        }
                        favoriteFilter.style.display = 'none';
                        favFilterVisible = false;
                    };
                });
            }
        });
    }

    // éšæœºå¤åˆ¶
    window.randomCopyFromPool = async function(poolId) {
        const resp = await fetch(`/api/random_pool/${poolId}/random`, { method: 'POST' });
        const data = await resp.json();
        if (data.success) {
            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            const tempInput = document.createElement('textarea');
            tempInput.value = data.code;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
            } catch (err) {}
            document.body.removeChild(tempInput);
            // æŸ¥è¯¦æƒ…å¹¶æ¸²æŸ“å¡ç‰‡
            const detailResp = await fetch('/api/scores/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ score_codes: [data.code] })
            });
            const detailData = await detailResp.json();
            if (detailData.success && detailData.results.length > 0) {
                updateRandomCopyCard(detailData.results[0]);
            } else {
                updateRandomCopyCard({ score_code: data.code, completion: null, is_favorite: false, has_review: false });
            }
            loadPools();
        } else {
            showToast('æŠ½å–å¤±è´¥ï¼š' + data.error);
        }
    };

    // å°å¡ç‰‡æ¸²æŸ“å’Œäº‹ä»¶ç»‘å®š
    function updateRandomCopyCard(scoreObj) {
        const randomCopyInfo = document.getElementById('randomCopyInfo');
        if (!randomCopyInfo) return;
        const hasCompletion = scoreObj.completion !== null && scoreObj.completion !== undefined;
        const completionText = hasCompletion ? `${scoreObj.completion}%` : 'æœªå®Œæˆ';
        const favoriteIcon = scoreObj.is_favorite ? 'â˜…' : 'â˜†';
        const heartIcon = scoreObj.has_review ? 'â¤ï¸' : 'ğŸ©¶';
        randomCopyInfo.innerHTML = `
          <div class="random-info-card">
            <div class="score-code-row">
              <span class="score-code">${scoreObj.score_code}</span>
              <span class="favorite-icon" style="cursor:pointer;">${favoriteIcon}</span>
            </div>
            <div class="completion-row">
              å®Œæˆç‡ï¼š<span class="completion-badge" style="cursor:pointer;">${completionText}</span>
            </div>
            <div class="actions-row" style="margin-top:10px; display:flex; gap:8px;">
              <button class="review-trigger" type="button" style="cursor:pointer;">${heartIcon}</button>
            </div>
          </div>
        `;
        // ç»‘å®šå®Œæˆç‡ç¼–è¾‘äº‹ä»¶
        randomCopyInfo.querySelector('.completion-badge').onclick = async function() {
            const newValue = prompt('è¯·è¾“å…¥æ–°çš„å®Œæˆç‡ï¼ˆ0-100ï¼‰', scoreObj.completion !== null ? scoreObj.completion : '');
            if (newValue === null) return;
            const num = parseInt(newValue);
            if (isNaN(num) || num < 0 || num > 100) {
                showToast('è¯·è¾“å…¥0-100ä¹‹é—´çš„æ•°å­—');
                return;
            }
            try {
                const resp = await fetch('/api/scores/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ score_code: scoreObj.score_code, completion: num })
                });
                const data = await resp.json();
                if (data.success) {
                    scoreObj.completion = num;
                    updateRandomCopyCard(scoreObj);
                    showToast('å®Œæˆç‡å·²æ›´æ–°');
                } else {
                    showToast('æ›´æ–°å¤±è´¥');
                }
            } catch (e) {
                showToast('ç½‘ç»œé”™è¯¯ï¼Œæ›´æ–°å¤±è´¥');
            }
        };
        // ç»‘å®šæ”¶è—åˆ‡æ¢äº‹ä»¶
        randomCopyInfo.querySelector('.favorite-icon').onclick = async function() {
            try {
                const resp = await fetch(`/api/scores/${scoreObj.score_code}/favorite`, {
                    method: 'POST'
                });
                const data = await resp.json();
                if (data.success) {
                    scoreObj.is_favorite = !scoreObj.is_favorite;
                    updateRandomCopyCard(scoreObj);
                    showToast(scoreObj.is_favorite ? 'å·²æ”¶è—' : 'å·²å–æ¶ˆæ”¶è—');
                } else {
                    showToast('æ“ä½œå¤±è´¥');
                }
            } catch (e) {
                showToast('ç½‘ç»œé”™è¯¯ï¼Œæ“ä½œå¤±è´¥');
            }
        };
        // ç»‘å®šè¯„ä»·æŒ‰é’®äº‹ä»¶
        const reviewTrigger = randomCopyInfo.querySelector('.review-trigger');
        if (reviewTrigger) {
            let hasReview = !!scoreObj.has_review;
            const refreshHeart = () => {
                reviewTrigger.textContent = hasReview ? 'â¤ï¸' : 'ğŸ©¶';
                reviewTrigger.title = hasReview ? 'æŸ¥çœ‹è¯„ä»·' : 'æ·»åŠ è¯„ä»·';
            };
            refreshHeart();
            reviewTrigger.onclick = async () => {
                if (!reviewModalInstance.isReady()) {
                    showToast('è¯„ä»·å¼¹çª—æœªåˆå§‹åŒ–');
                    return;
                }
                const preferredMode = hasReview ? 'view' : 'create';
                const { mode } = await reviewModalInstance.open({
                    scoreCode: scoreObj.score_code,
                    mode: preferredMode,
                    onSaved: () => {
                        hasReview = true;
                        scoreObj.has_review = true;
                        refreshHeart();
                        loadPools();
                    }
                });
                if (mode === 'view') {
                    hasReview = true;
                    scoreObj.has_review = true;
                    refreshHeart();
                } else if (preferredMode === 'view' && mode === 'create') {
                    hasReview = false;
                    scoreObj.has_review = false;
                    refreshHeart();
                }
            };
        }
    }

    // åˆ é™¤æ± 
    window.deletePool = async function(poolId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥æ± å—ï¼Ÿ')) return;
        const resp = await fetch(`/api/random_pool/${poolId}/delete`, { method: 'POST' });
        const data = await resp.json();
        if (data.success) {
            loadPools();
        } else {
            alert('åˆ é™¤å¤±è´¥ï¼š' + data.error);
        }
    };

    // æŸ¥è¯¢å’Œæ’é™¤åŠŸèƒ½
    window.queryOrExcludePool = async function(poolId, type, btn) {
        if (btn) btn.disabled = true;
        const input = prompt(type === 'query' ? 'è¯·è¾“å…¥è¦æŸ¥è¯¢çš„æ›²è°±ç ï¼ˆå¯å¤šè¡Œï¼‰' : 'è¯·è¾“å…¥è¦æ’é™¤çš„æ›²è°±ç ï¼ˆå¯å¤šè¡Œï¼‰');
        if (input === null) { if (btn) btn.disabled = false; return; }
        const codes = input.split(/\r?\n/).map(s=>s.trim()).filter(s=>/^\d{5,}$/.test(s));
        if (!codes.length) { showToast('æ— æœ‰æ•ˆæ›²è°±ç '); if (btn) btn.disabled = false; return; }
        // è·å–å½“å‰æ± å†…å®¹
        const resp = await fetch('/api/random_pool/list');
        const data = await resp.json();
        if (!data.success) { showToast('æ“ä½œå¤±è´¥'); if (btn) btn.disabled = false; return; }
        const pool = data.pools.find(p=>p.id==poolId);
        if (!pool) { showToast('æ± ä¸å­˜åœ¨'); if (btn) btn.disabled = false; return; }
        let newCodes;
        if (type === 'query') {
            // åªä¿ç•™è¾“å…¥çš„ç ä¸”åœ¨æ± å†…
            newCodes = pool.codes.filter(code=>codes.includes(code));
        } else {
            // æ’é™¤è¾“å…¥çš„ç 
            newCodes = pool.codes.filter(code=>!codes.includes(code));
        }
        // æ›´æ–°æ± 
        await fetch(`/api/random_pool/${poolId}/filter`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filter: {}, codes: newCodes })
        });
        await loadPools();
        showToast(type === 'query' ? 'æŸ¥è¯¢å®Œæˆ' : 'æ’é™¤å®Œæˆ');
        if (btn) btn.disabled = false;
    };

    // é‡ç½®æ± åŠŸèƒ½
    window.resetPool = async function(poolId, btn) {
        if (!confirm('ç¡®å®šè¦é‡ç½®è¯¥æ± å†…å®¹ä¸ºæœ€åˆå…¨é‡å—ï¼Ÿ')) return;
        if (btn) btn.disabled = true;
        const resp = await fetch(`/api/random_pool/${poolId}/reset`, { method: 'POST' });
        const data = await resp.json();
        if (data.success) {
            await loadPools();
            showToast('æ± å·²é‡ç½®ä¸ºåˆå§‹å†…å®¹');
        } else {
            showToast('é‡ç½®å¤±è´¥ï¼š' + data.error);
        }
        if (btn) btn.disabled = false;
    };

    // åˆå§‹åŠ è½½
    loadPools();

    // Toast æç¤º
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        toast.offsetHeight;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 2000);
    }
    </script>
</body>
</html> 
