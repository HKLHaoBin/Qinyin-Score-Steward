<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>æˆ‘å–œæ¬¢çš„è°±å­ Â· åƒéŸ³è°±å¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="stylesheet" href="/static/style.css">
  <script>
    // æ·±è‰²æ¨¡å¼é—ªçƒé¿å…ï¼ˆå¤ç”¨ä½ é¦–é¡µçš„ç­–ç•¥ï¼‰
    (function() {
      const stored = localStorage.getItem('theme');
      const preferDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (stored === 'dark' || (!stored && preferDark)) {
        document.documentElement.setAttribute('data-theme', 'dark');
      } else if (stored === 'light') {
        document.documentElement.removeAttribute('data-theme');
      }
    })();
  </script>
  <style>
    /* ===== Likes Page ç²¾è‡´æ ·å¼ï¼Œç‹¬ç«‹å‘½åç©ºé—´ likes-* ===== */

    .likes-wrap {padding: 0 16px; }
    .likes-header {
      display:flex; align-items:center; gap:12px; justify-content:space-between; flex-wrap:wrap; margin-bottom:16px;
    }
    .likes-title { display:flex; align-items:center; gap:10px; }
    .likes-title h1 { margin:0; font-size:22px; }
    .likes-title .count { opacity:.7; font-size:14px; }

    /* ==== ä¸¤æ å¸ƒå±€ï¼šå·¦ä¾§æ‚¬æµ®æ  + å³ä¾§è‡ªé€‚åº” ==== */
    .likes-layout {
    display: grid;
    grid-template-columns: 320px 4fr;
    gap: 15px;
    align-items: start;
}

    /* å·¦ä¾§ï¼šæ‚¬æµ®ï¼ˆè·Ÿéšé¡µé¢æ»šåŠ¨åˆ°é¡¶éƒ¨åå›ºå®šï¼‰ */
    .likes-sidebar {
      position: sticky;
      top: 16px;            /* ä½ é¡µé¢å¤´éƒ¨ä¸å¯¼èˆªçš„é¢„ç•™ç©ºé—´ */
      height: max-content;  /* è®©å®¹å™¨åˆšå¥½åŒ…ä½å†…å®¹ */
      z-index: 2;
    }

    /* å·¥å…·æ åœ¨ä¾§æ é‡Œç…§å¸¸æ˜¾ç¤ºå³å¯ */
    .likes-toolbar {
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: var(--card-bg, #fff);
      border: 1px solid var(--border, #e2e2e2);
      padding: 12px;
      border-radius: 12px;
    }
    .random-pick { display:flex; flex-direction:column; gap:6px; }
    .likes-search {
      display:flex; align-items:center;;
      background: var(--bg,#fff); border:1px solid var(--border,#e2e2e2); border-radius:10px; padding:8px 10px;
    }
    .likes-search input { flex:1; border:0; outline:none; background:transparent; color:var(--fg,#222); }
    .likes-chipbar { display:flex; gap:6px; flex-wrap:wrap; }
    .likes-chip {
      border:1px solid var(--border,#e2e2e2); background:var(--bg,#fff); padding:6px 10px; border-radius:999px; cursor:pointer; font-size:13px;
    }
    .likes-chip.active { background: var(--accent,#3b82f6); color:#fff; border-color:transparent; }
    .likes-toggle { display:flex; align-items:center; gap:6px; font-size:13px; }
    .likes-select { border:1px solid var(--border,#e2e2e2); background:var(--bg,#fff); border-radius:10px; padding:6px 10px; }

    /* å³ä¾§å†…å®¹åŒº */
    .likes-main {
      min-width: 0; /* é˜²æ­¢å†…å®¹æ’‘ç ´ */
      display: flex;
      justify-content: flex-end;
    }

    /* ç½‘æ ¼å¡ç‰‡ï¼šåœ¨å³ä¾§åŒºåŸŸè‡ªé€‚åº”é“ºæ»¡ */
    .likes-grid {
      display:grid; gap:14px;
      grid-template-columns: repeat(auto-fill, minmax(263px, 1fr));
      justify-content: flex-end;
      width: 100%;
      max-width: 100%;
    }

    /* å“åº”å¼ï¼šçª„å±ä¸‹æ”¹ä¸ºä¸Šä¸‹ç»“æ„ï¼ˆä¾§æ åœ¨ä¸Šæ–¹ï¼‰ */
    @media (max-width: 900px) {
      .likes-layout {
        grid-template-columns: 1fr;
      }
      .likes-sidebar {
        position: static; /* æ‰‹æœºä¸Šä¸æ‚¬æµ®ï¼Œé¿å…é®æŒ¡ */
      }
    }
    .likes-card {
      background: var(--card-bg,#fff); border:1px solid var(--border,#e2e2e2);
      border-radius:14px; padding:12px; box-shadow: 0 6px 20px rgba(0,0,0,.06);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      display:flex; flex-direction:column; gap:10px;
      cursor: pointer;
      min-width: 315px;
    }
    .likes-card:hover { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(0,0,0,.10); border-color: rgba(99,102,241,.28); }
    .likes-card.likes-card--sidebar {
      min-width: auto;
      width: 100%;
      padding: 10px;
      gap: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,.05);
      font-size: 12px;
    }
    .likes-card--sidebar .likes-row { gap: 6px; }
    .likes-card--sidebar .likes-code { font-size: 15px; }
    .likes-card--sidebar .stars { font-size: 14px; }
    .likes-card--sidebar .comment { font-size: 12px; max-height: 48px; }
    .likes-card--sidebar .likes-actions { gap: 6px; }
    .likes-card--sidebar .likes-actions .btn { flex:1; padding:6px 8px; font-size: 12px; }

    .likes-row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .likes-code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-weight:600; }
    .likes-badges { display:flex; align-items:center; gap:6px; }
    .badge {
      border:1px solid var(--border,#e2e2e2); border-radius:999px; padding:2px 8px; font-size:12px; opacity:.9; background: var(--bg,#fff);
    }
    .badge.video { border-color: rgba(245,158,11,.55); }
    .badge.fav  { border-color: rgba(99,102,241,.5); }

    .stars { display:flex; gap:2px; font-size:16px; color: #f5b400; }
    .comment {
      font-size: 13px; line-height:1.5; opacity:.9; max-height: 60px; overflow: hidden; text-overflow: ellipsis;
    }
    .likes-actions { display:flex; gap:8px; }
    .btn {
      border:1px solid var(--border,#e2e2e2); background: var(--bg,#fff); padding:6px 10px; border-radius:10px; cursor:pointer; font-size:13px;
    }
    .btn:hover { filter: brightness(0.98); }
    .btn.primary { background: var(--accent,#3b82f6); color:#fff; border-color: transparent; }
    .muted { opacity:.7; font-size:12px; }

    /* skeleton */
    .skeleton { position:relative; overflow:hidden; background:linear-gradient(90deg, rgba(0,0,0,.06), rgba(0,0,0,.12), rgba(0,0,0,.06)); background-size:200% 100%; animation:shimmer 1.2s infinite; border-radius:10px; }
    @keyframes shimmer { 0%{background-position:100% 0} 100%{background-position:-100% 0} }

    /* Modalï¼ˆåªè¯»æŸ¥çœ‹ï¼‰ */
    .qyj-modal { position: fixed; inset: 0; display: none; }
    .qyj-modal.is-open { display: block; }
    .qyj-modal__backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.45); backdrop-filter: blur(2px); }
    .qyj-modal__card {
      position: relative;
      z-index:1;
      margin: 8vh auto 0;
      width: min(620px, 94vw);
      max-height: 90vh;
      background: var(--card-bg,#fff);
      color: var(--fg,#222);
      border-radius: 14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.2);
      padding: 20px 22px 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .qyj-modal__header { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
    .qyj-modal__close { border:0; background:transparent; font-size:18px; cursor:pointer; opacity:.8; }
    .viewer-meta { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 6px 0 10px; }
    .viewer-comment { white-space:pre-wrap; line-height:1.6; font-size:14px; opacity:.95; padding:10px; border:1px dashed var(--border,#e2e2e2); border-radius:10px; }
    .viewer-video { width:100%; border-radius:12px; margin-top:10px; display:block; }
    .viewer-embed { position:relative; width:100%; padding-top:56.25%; border-radius:12px; overflow:hidden; margin-top:10px; background:#000; display:none; }
    .viewer-embed iframe { position:absolute; inset:0; width:100%; height:100%; border:0; }
    .viewer-actions { display:flex; justify-content:flex-end; gap:8px; margin-top:auto; padding-top:8px; }
  </style>
</head>
<body>
  <div class="likes-wrap">
    <div class="likes-header">
      <div class="likes-title">
        <h1>æˆ‘å–œæ¬¢çš„è°±å­</h1>
        <span class="count" id="likesCount"></span>
      </div>
      <a href="/" class="btn">â† è¿”å›é¦–é¡µ</a>
    </div>

    <div class="likes-layout">
      <!-- å·¦ä¾§æ‚¬æµ®ä¾§æ  -->
      <aside class="likes-sidebar">
        <div class="likes-toolbar">
          <div class="likes-search">
            <span>ğŸ”</span>
            <input id="qInput" placeholder="æŒ‰æ›²è°±ç æˆ–è¯„è¯­å…³é”®å­—æœç´¢â€¦">
          </div>

          <div class="likes-chipbar" id="ratingChips">
            <button class="likes-chip active" data-val="0">å…¨éƒ¨è¯„åˆ†</button>
            <button class="likes-chip" data-val="5">â‰¥ 5 æ˜Ÿ</button>
            <button class="likes-chip" data-val="4">â‰¥ 4 æ˜Ÿ</button>
            <button class="likes-chip" data-val="3">â‰¥ 3 æ˜Ÿ</button>
          </div>

          <label class="likes-toggle">
            <input type="checkbox" id="videoOnly"> ä»…çœ‹æœ‰è§†é¢‘
          </label>

          <select id="sortSelect" class="likes-select" title="æ’åº">
            <option value="latest">æœ€æ–°ä¼˜å…ˆ</option>
            <option value="rating_desc">è¯„åˆ†ä»é«˜åˆ°ä½</option>
            <option value="rating_asc">è¯„åˆ†ä»ä½åˆ°é«˜</option>
          </select>

          <button id="refreshBtn" class="btn">åˆ·æ–°</button>
          <button id="randomCopyBtn" class="btn">éšæœºå¤åˆ¶</button>
          <div id="randomPickContainer" class="random-pick" aria-live="polite"></div>
        </div>
      </aside>

      <!-- å³ä¾§å†…å®¹åŒºï¼šç½‘æ ¼é“ºæ»¡ -->
      <main class="likes-main">
        <div id="likesGrid" class="likes-grid" aria-live="polite"></div>
      </main>
    </div>
  </div>

  <!-- æŸ¥çœ‹è¯„ä»· Modalï¼ˆåªè¯»ï¼‰ -->
  <div id="viewerModal" class="qyj-modal" aria-hidden="true">
    <div class="qyj-modal__backdrop" data-close></div>
    <div class="qyj-modal__card" role="dialog" aria-modal="true" aria-labelledby="viewerTitle">
      <div class="qyj-modal__header">
        <h3 id="viewerTitle">è¯„ä»·è¯¦æƒ…</h3>
        <button id="viewerClose" class="qyj-modal__close" aria-label="å…³é—­">âœ•</button>
      </div>
      <div class="viewer-meta">
        <span id="viewerCode" class="badge">-</span>
        <span id="viewerStars" class="stars"></span>
        <span id="viewerComp" class="badge">å®Œæˆç‡ -</span>
        <span id="viewerFav" class="badge fav">æ”¶è— -</span>
        <span id="viewerTime" class="muted"></span>
      </div>
      <div id="viewerViewContent">
        <div id="viewerComment" class="viewer-comment"></div>
        <video id="viewerVideo" class="viewer-video" controls style="display:none;"></video>
        <div id="viewerEmbed" class="viewer-embed"></div>
      </div>
      <div id="viewerEditContent" style="display:none;">
        <div class="qyj-field">
          <label class="qyj-label">æ‰“åˆ†</label>
          <div id="viewerEditStars" class="qyj-stars" role="radiogroup" aria-label="å–œæ¬¢ç¨‹åº¦ 1 åˆ° 5 æ˜Ÿ">
            <button type="button" class="qyj-star" data-val="1" aria-checked="false" role="radio">â˜†</button>
            <button type="button" class="qyj-star" data-val="2" aria-checked="false" role="radio">â˜†</button>
            <button type="button" class="qyj-star" data-val="3" aria-checked="false" role="radio">â˜†</button>
            <button type="button" class="qyj-star" data-val="4" aria-checked="false" role="radio">â˜†</button>
            <button type="button" class="qyj-star" data-val="5" aria-checked="true" role="radio">â˜†</button>
          </div>
          <input type="hidden" id="viewerEditRating" value="5">
        </div>
        <div class="qyj-field">
          <label class="qyj-label" for="viewerEditComment">è¯„è¯­ *</label>
          <textarea id="viewerEditComment" rows="4" class="qyj-textarea" placeholder="è¯´è¯´æ–°çš„æƒ³æ³•â€¦"></textarea>
        </div>
        <div class="qyj-field" id="viewerEditVideoSourceField">
          <label class="qyj-label">è§†é¢‘æ¥æº</label>
          <div class="qyj-radio-group">
            <label class="qyj-radio" id="viewerEditKeepWrapper">
              <input type="radio" name="viewerEditVideoSource" value="keep" checked>
              ä¿ç•™ç°æœ‰è§†é¢‘
            </label>
            <label class="qyj-radio">
              <input type="radio" name="viewerEditVideoSource" value="upload">
              ä¸Šä¼ æ–°è§†é¢‘
            </label>
            <label class="qyj-radio">
              <input type="radio" name="viewerEditVideoSource" value="external">
              ä½¿ç”¨è§†é¢‘é“¾æ¥ / Bç«™åµŒå…¥ä»£ç 
            </label>
          </div>
          <div class="qyj-tip-sm" id="viewerEditKeepTip">å½“å‰å°†ä¿ç•™å·²æœ‰çš„è§†é¢‘ã€‚</div>
        </div>
        <div class="qyj-field" id="viewerEditFileRow" style="display:none;">
          <label class="qyj-label" for="viewerEditVideoFile">ä¸Šä¼ æ–°è§†é¢‘</label>
          <label class="qyj-file">
            <input type="file" id="viewerEditVideoFile" accept=".mp4,.mov,.m4v,.webm,.avi,.mkv">
            <span class="qyj-file__btn">é€‰æ‹©æ–‡ä»¶</span>
            <span class="qyj-file__name" id="viewerEditVideoFileName">æœªé€‰æ‹©æ–‡ä»¶</span>
          </label>
          <div class="qyj-tip-sm">æ”¯æŒ mp4 / mov / webm / avi / mkvã€‚</div>
        </div>
        <div class="qyj-field" id="viewerEditUrlRow" style="display:none;">
          <div class="qyj-tip-sm">
            <a class="qyj-link-btn" href="https://member.bilibili.com/platform/upload/video/frame" target="_blank" rel="noopener noreferrer">
              <span class="qyj-link-btn__icon">ğŸ“¤</span>
              <span>è·³è½¬æŠ•ç¨¿</span>
            </a>
          </div>
          <label class="qyj-label" for="viewerEditVideoUrl">è§†é¢‘é“¾æ¥æˆ–åµŒå…¥ä»£ç </label>
          <textarea id="viewerEditVideoUrl" rows="3" class="qyj-textarea" placeholder="ç²˜è´´è§†é¢‘ URL æˆ– Bç«™åµŒå…¥ä»£ç "></textarea>
          <div class="qyj-tip-sm">è‹¥åˆ‡æ¢ä¸ºé“¾æ¥ï¼Œå°†è‡ªåŠ¨æ›¿æ¢åŸæœ‰è§†é¢‘æ–‡ä»¶ã€‚</div>
        </div>
        <div class="qyj-field" id="viewerEditPreviewRow" style="display:none;">
          <label class="qyj-label">é¢„è§ˆ</label>
          <video id="viewerEditVideoPreview" controls style="width:100%; border-radius:10px; display:none;"></video>
          <div id="viewerEditEmbedPreview" class="review-embed" style="display:none;"></div>
        </div>
        <div id="viewerEditMsg" class="qyj-msg"></div>
      </div>
      <div class="viewer-actions" id="viewerViewActions">
        <button id="viewerEditBtn" class="btn">ç¼–è¾‘</button>
        <button id="viewerCopy" class="btn">å¤åˆ¶æ›²è°±ç </button>
        <button id="viewerClose2" class="btn primary">å…³é—­</button>
      </div>
      <div class="viewer-actions" id="viewerEditActions" style="display:none;">
        <button id="viewerEditCancel" class="btn">å–æ¶ˆç¼–è¾‘</button>
        <button id="viewerEditSubmit" class="btn primary">ä¿å­˜ä¿®æ”¹</button>
      </div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const grid = $('#likesGrid');
    const countEl = $('#likesCount');
    const randomContainer = $('#randomPickContainer');
    const randomBtn = $('#randomCopyBtn');

    const state = {
      q: '', minRating: 0, videoOnly: false, sort: 'latest'
    };
    let currentList = [];

    function setCount(n){ countEl.textContent = `ï¼ˆå…± ${n} é¦–ï¼‰`; }

    function skeleton(n=8){
      grid.innerHTML = '';
      for(let i=0;i<n;i++){
        const card = document.createElement('div');
        card.className = 'likes-card';
        card.innerHTML = `
          <div class="likes-row"><div class="skeleton" style="width:40%;height:16px;"></div><div class="skeleton" style="width:28%;height:18px;"></div></div>
          <div class="skeleton" style="width:80%;height:14px;"></div>
          <div class="skeleton" style="width:100%;height:48px;"></div>
          <div class="likes-row"><div class="skeleton" style="width:28%;height:28px;"></div><div class="skeleton" style="width:38%;height:28px;"></div></div>
        `;
        grid.appendChild(card);
      }
      setCount(0);
    }

    function toStars(n){
      const k = Math.max(0, Math.min(5, Number(n)||0));
      return 'â˜…'.repeat(k) + 'â˜†'.repeat(5-k);
    }

    function copy(text){
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    }

    function detectVideoType(value, fallback = 'none'){
      if (!value) return fallback;
      const trimmed = String(value).trim();
      if (!trimmed) return fallback;
      if (trimmed.toLowerCase().startsWith('<iframe')) return 'embed';
      if (/^https?:\/\//i.test(trimmed)) return 'url';
      return fallback;
    }

    function toast(text){
      let t = document.querySelector('.qyj-toast');
      if (!t) {
        t = document.createElement('div');
        t.className = 'qyj-toast';
        document.body.appendChild(t);
      }
      t.textContent = text;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 1800);
    }

    function createCardElement(item, options = {}){
      const card = document.createElement('div');
      card.className = 'likes-card';
      if (options.extraClass) {
        card.classList.add(options.extraClass);
      }
      card.innerHTML = `
          <div class="likes-row">
            <div class="likes-code">${item.score_code}</div>
            <div class="stars" title="${item.rating} æ˜Ÿ">${toStars(item.rating)}</div>
          </div>
          <div class="likes-row">
            <div class="likes-badges">
              ${item.video_url ? '<span class="badge video">ğŸ¬ è§†é¢‘</span>' : ''}
              <span class="badge">å®Œæˆç‡ ${item.completion != null ? (item.completion + '%') : '-'}</span>
            </div>
            <div class="muted">${new Date(item.created_at.replace(' ','T')).toLocaleDateString()}</div>
          </div>
          <div class="comment" title="${(item.comment||'').replace(/"/g,'&quot;')}">${item.comment || 'ï¼ˆæ— è¯„è¯­ï¼‰'}</div>
          <div class="likes-actions">
            <button class="btn" data-act="copy">å¤åˆ¶æ›²è°±ç </button>
            <button class="btn primary" data-act="view">æŸ¥çœ‹è¯„ä»·</button>
            <button class="btn" data-act="edit">ç¼–è¾‘</button>
          </div>
        `;
      card.addEventListener('click', (e)=>{
        const act = e.target?.dataset?.act;
        if (act === 'copy') { copy(item.score_code); e.stopPropagation(); }
        else if (act === 'edit') { openViewer(item, 'edit'); e.stopPropagation(); }
        else { openViewer(item); }
      });
      return card;
    }

    let currentViewerItem = null;
    let isEditMode = false;

    const viewerModalEl = $('#viewerModal');
    const viewerCloseBtn = $('#viewerClose');
    const viewerClose2Btn = $('#viewerClose2');
    const viewerCopyBtn = $('#viewerCopy');
    const viewerEditBtn = $('#viewerEditBtn');
    const viewerEditCancelBtn = $('#viewerEditCancel');
    const viewerEditSubmitBtn = $('#viewerEditSubmit');
    const viewerTitleEl = $('#viewerTitle');
    const viewerCodeEl = $('#viewerCode');
    const viewerStarsEl = $('#viewerStars');
    const viewerCompEl = $('#viewerComp');
    const viewerFavEl = $('#viewerFav');
    const viewerTimeEl = $('#viewerTime');
    const viewerCommentEl = $('#viewerComment');
    const viewerVideoEl = $('#viewerVideo');
    const viewerEmbedEl = $('#viewerEmbed');
    const viewerViewContent = $('#viewerViewContent');
    const viewerEditContent = $('#viewerEditContent');
    const viewerViewActions = $('#viewerViewActions');
    const viewerEditActions = $('#viewerEditActions');
    const viewerEditStars = document.querySelectorAll('#viewerEditStars .qyj-star');
    const viewerEditRatingInput = document.getElementById('viewerEditRating');
    const viewerEditCommentInput = document.getElementById('viewerEditComment');
    const viewerEditVideoSourceRadios = document.querySelectorAll('input[name="viewerEditVideoSource"]');
    const viewerEditFileRow = $('#viewerEditFileRow');
    const viewerEditUrlRow = $('#viewerEditUrlRow');
    const viewerEditVideoFile = document.getElementById('viewerEditVideoFile');
    const viewerEditVideoFileName = document.getElementById('viewerEditVideoFileName');
    const viewerEditVideoUrlInput = document.getElementById('viewerEditVideoUrl');
    const viewerEditPreviewRow = $('#viewerEditPreviewRow');
    const viewerEditVideoPreview = document.getElementById('viewerEditVideoPreview');
    const viewerEditEmbedPreview = document.getElementById('viewerEditEmbedPreview');
    const viewerEditMsgEl = document.getElementById('viewerEditMsg');
    const viewerEditKeepWrapper = document.getElementById('viewerEditKeepWrapper');
    const viewerEditKeepTip = document.getElementById('viewerEditKeepTip');

    function resetViewerMedia(){
      if (viewerVideoEl) {
        try { viewerVideoEl.pause(); } catch(e) { /* ignore */ }
        viewerVideoEl.removeAttribute('src');
        viewerVideoEl.style.display = 'none';
      }
      if (viewerEmbedEl) {
        viewerEmbedEl.innerHTML = '';
        viewerEmbedEl.style.display = 'none';
      }
    }

    function renderViewerView(item){
      viewerTitleEl.textContent = 'è¯„ä»·è¯¦æƒ…';
      viewerCodeEl.textContent = item.score_code;
      viewerStarsEl.textContent = toStars(item.rating);
      viewerCompEl.textContent = 'å®Œæˆç‡ ' + (item.completion != null ? (item.completion + '%') : '-');
      viewerFavEl.textContent = 'æ”¶è— ' + (item.is_favorite ? 'â˜…' : 'â˜†');
      viewerTimeEl.textContent = new Date(item.created_at.replace(' ', 'T')).toLocaleString();
      viewerCommentEl.textContent = item.comment || 'ï¼ˆæ— è¯„è¯­ï¼‰';
      resetViewerMedia();
      const videoType = item.video_type || detectVideoType(item.video_url);
      if (videoType === 'embed' && viewerEmbedEl && item.video_url){
        viewerEmbedEl.innerHTML = item.video_url;
        viewerEmbedEl.style.display = 'block';
      } else if (item.video_url && viewerVideoEl){
        viewerVideoEl.src = item.video_url;
        viewerVideoEl.style.display = 'block';
      }
    }

    function resetViewerEditPreview(){
      if (viewerEditVideoPreview) {
        try { viewerEditVideoPreview.pause(); } catch(e) { /* ignore */ }
        viewerEditVideoPreview.removeAttribute('src');
        viewerEditVideoPreview.style.display = 'none';
      }
      if (viewerEditEmbedPreview) {
        viewerEditEmbedPreview.innerHTML = '';
        viewerEditEmbedPreview.style.display = 'none';
      }
      if (viewerEditPreviewRow) viewerEditPreviewRow.style.display = 'none';
    }

    function showViewerEditPreview(videoType, videoValue){
      resetViewerEditPreview();
      if (!videoType || !videoValue) return;
      if (viewerEditPreviewRow) viewerEditPreviewRow.style.display = 'block';
      if (videoType === 'embed' && viewerEditEmbedPreview) {
        viewerEditEmbedPreview.innerHTML = videoValue;
        viewerEditEmbedPreview.style.display = 'block';
      } else if (viewerEditVideoPreview) {
        viewerEditVideoPreview.src = videoValue;
        viewerEditVideoPreview.style.display = 'block';
      }
    }

    function updateViewerEditVideoSourceUI(source){
      if (viewerEditFileRow) viewerEditFileRow.style.display = source === 'upload' ? 'block' : 'none';
      if (viewerEditUrlRow) viewerEditUrlRow.style.display = source === 'external' ? 'block' : 'none';
      if (viewerEditKeepTip) {
        if (source === 'keep') viewerEditKeepTip.textContent = 'å½“å‰å°†ä¿ç•™å·²æœ‰çš„è§†é¢‘ã€‚';
        else if (source === 'upload') viewerEditKeepTip.textContent = 'ä¸Šä¼ åå°†æ›¿æ¢å½“å‰è§†é¢‘ã€‚';
        else viewerEditKeepTip.textContent = 'å°†ä½¿ç”¨æä¾›çš„é“¾æ¥æˆ–åµŒå…¥ä»£ç æ›¿æ¢å½“å‰è§†é¢‘ã€‚';
      }
    }

    function setViewerEditVideoSource(value){
      Array.from(viewerEditVideoSourceRadios).forEach(radio => {
        radio.checked = radio.value === value;
      });
      updateViewerEditVideoSourceUI(value);
    }

    function getViewerEditVideoSource(){
      const selected = Array.from(viewerEditVideoSourceRadios).find(radio => radio.checked);
      return selected ? selected.value : 'keep';
    }

    function paintViewerEditStars(n){
      Array.from(viewerEditStars).forEach(btn => {
        const v = Number(btn.dataset.val);
        const active = v <= n;
        btn.textContent = active ? 'â˜…' : 'â˜†';
        btn.setAttribute('aria-checked', String(v === n));
        btn.classList.toggle('is-active', active);
      });
    }

    function exitEditMode(){
      isEditMode = false;
      if (viewerEditMsgEl) viewerEditMsgEl.textContent = '';
      if (viewerEditContent) viewerEditContent.style.display = 'none';
      if (viewerEditActions) viewerEditActions.style.display = 'none';
      if (viewerViewContent) viewerViewContent.style.display = 'block';
      if (viewerViewActions) viewerViewActions.style.display = 'flex';
      if (viewerEditVideoFile) viewerEditVideoFile.value = '';
      if (viewerEditVideoFileName) viewerEditVideoFileName.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
      if (viewerEditVideoUrlInput) viewerEditVideoUrlInput.value = '';
      resetViewerEditPreview();
    }

    function enterEditMode(){
      if (!currentViewerItem) return;
      isEditMode = true;
      if (viewerEditContent) viewerEditContent.style.display = 'block';
      if (viewerEditActions) viewerEditActions.style.display = 'flex';
      if (viewerViewContent) viewerViewContent.style.display = 'none';
      if (viewerViewActions) viewerViewActions.style.display = 'none';
      if (viewerEditMsgEl) viewerEditMsgEl.textContent = '';

      const rating = Number(currentViewerItem.rating) || 5;
      if (viewerEditRatingInput) viewerEditRatingInput.value = String(rating);
      paintViewerEditStars(rating);
      if (viewerEditCommentInput) viewerEditCommentInput.value = currentViewerItem.comment || '';

      const hasVideo = !!(currentViewerItem.video_url && currentViewerItem.video_url.trim());
      if (viewerEditKeepWrapper) viewerEditKeepWrapper.style.display = hasVideo ? 'inline-flex' : 'none';
      const defaultSource = hasVideo ? 'keep' : 'external';
      setViewerEditVideoSource(defaultSource);
      if (!hasVideo && viewerEditKeepTip) viewerEditKeepTip.textContent = 'å½“å‰æ— è§†é¢‘ï¼Œå¯é€‰æ‹©ä¸Šä¼ æˆ–æä¾›é“¾æ¥ã€‚';
      if (viewerEditVideoUrlInput) viewerEditVideoUrlInput.value = currentViewerItem.video_url || '';
      showViewerEditPreview(currentViewerItem.video_type || detectVideoType(currentViewerItem.video_url), currentViewerItem.video_url);
    }

    async function submitViewerEdit(){
      if (!currentViewerItem || !viewerEditSubmitBtn) return;
      if (viewerEditMsgEl) viewerEditMsgEl.textContent = '';

      const rating = Number(viewerEditRatingInput?.value || 5);
      if (!(rating >= 1 && rating <= 5)) {
        if (viewerEditMsgEl) viewerEditMsgEl.textContent = 'è¯„åˆ†å¿…é¡»æ˜¯ 1-5';
        return;
      }
      const comment = (viewerEditCommentInput?.value || '').trim();
      if (!comment) {
        if (viewerEditMsgEl) viewerEditMsgEl.textContent = 'è¯„è¯­ä¸èƒ½ä¸ºç©º';
        return;
      }

      const videoSource = getViewerEditVideoSource();
      const fd = new FormData();
      fd.append('rating', String(rating));
      fd.append('comment', comment);

      if (videoSource === 'external') {
        const externalValue = (viewerEditVideoUrlInput?.value || '').trim();
        if (!externalValue) {
          if (viewerEditMsgEl) viewerEditMsgEl.textContent = 'è¯·å¡«å†™è§†é¢‘é“¾æ¥æˆ–åµŒå…¥ä»£ç ';
          return;
        }
        fd.append('video_source', 'external');
        fd.append('video_url', externalValue);
      } else if (videoSource === 'upload') {
        const file = viewerEditVideoFile?.files?.[0];
        if (!file) {
          if (viewerEditMsgEl) viewerEditMsgEl.textContent = 'è¯·é€‰æ‹©è¦ä¸Šä¼ çš„è§†é¢‘æ–‡ä»¶';
          return;
        }
        fd.append('video_source', 'upload');
        fd.append('video', file);
      } else {
        fd.append('video_source', 'keep');
      }

      viewerEditSubmitBtn.disabled = true;
      const originalText = viewerEditSubmitBtn.textContent;
      viewerEditSubmitBtn.textContent = 'ä¿å­˜ä¸­â€¦';

      try {
        const resp = await fetch(`/api/reviews/${currentViewerItem.review_id}`, {
          method: 'PUT',
          body: fd
        });
        const data = await resp.json();
        if (!resp.ok || !data.success) throw new Error(data.error || 'ä¿å­˜å¤±è´¥');
        if (viewerEditMsgEl) viewerEditMsgEl.textContent = 'ä¿å­˜æˆåŠŸï¼';
        toast('è¯„ä»·å·²æ›´æ–°');

        Object.assign(currentViewerItem, {
          rating: data.rating,
          comment: data.comment,
          video_url: data.video_url,
          video_type: data.video_type,
          created_at: data.created_at
        });

        // æ›´æ–°åˆ—è¡¨ç¼“å­˜
        const idx = currentList.findIndex(r => r.review_id === currentViewerItem.review_id);
        if (idx >= 0) {
          currentList[idx] = { ...currentList[idx], ...currentViewerItem };
        }

        renderViewerView(currentViewerItem);
        exitEditMode();
        load(); // åˆ·æ–°åˆ—è¡¨
      } catch (error) {
        const msg = error.message || 'ä¿å­˜å¤±è´¥';
        if (viewerEditMsgEl) viewerEditMsgEl.textContent = `ä¿å­˜å¤±è´¥ï¼š${msg}`;
        toast(`ä¿å­˜å¤±è´¥ï¼š${msg}`);
      } finally {
        viewerEditSubmitBtn.disabled = false;
        viewerEditSubmitBtn.textContent = originalText;
      }
    }

    function openViewer(item, mode = 'view'){
      currentViewerItem = { ...item };
      renderViewerView(currentViewerItem);
      exitEditMode();
      if (mode === 'edit') {
        enterEditMode();
      }
      viewerModalEl.classList.add('is-open');
      viewerModalEl.setAttribute('aria-hidden','false');
      if (viewerCopyBtn) viewerCopyBtn.onclick = () => copy(currentViewerItem.score_code);
    }

    function closeViewer(){
      exitEditMode();
      resetViewerMedia();
      viewerModalEl.classList.remove('is-open');
      viewerModalEl.setAttribute('aria-hidden','true');
      currentViewerItem = null;
    }

    viewerEditStars.forEach(btn => {
      btn.addEventListener('click', () => {
        const v = Number(btn.dataset.val);
        if (v >= 1 && v <= 5) {
          if (viewerEditRatingInput) viewerEditRatingInput.value = String(v);
          paintViewerEditStars(v);
        }
      });
      btn.addEventListener('keydown', (e) => {
        const cur = Number(viewerEditRatingInput?.value || 5);
        if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') {
          e.preventDefault();
          const v = Math.max(1, cur - 1);
          if (viewerEditRatingInput) viewerEditRatingInput.value = String(v);
          paintViewerEditStars(v);
        } else if (e.key === 'ArrowRight' || e.key === 'ArrowUp') {
          e.preventDefault();
          const v = Math.min(5, cur + 1);
          if (viewerEditRatingInput) viewerEditRatingInput.value = String(v);
          paintViewerEditStars(v);
        }
      });
    });

    Array.from(viewerEditVideoSourceRadios).forEach(radio => {
      radio.addEventListener('change', () => {
        updateViewerEditVideoSourceUI(radio.value);
        if (radio.value === 'keep' && currentViewerItem) {
          showViewerEditPreview(currentViewerItem.video_type || detectVideoType(currentViewerItem.video_url), currentViewerItem.video_url);
        } else if (radio.value === 'external') {
          const previewType = detectVideoType(viewerEditVideoUrlInput?.value, 'url');
          showViewerEditPreview(previewType, viewerEditVideoUrlInput?.value);
        } else {
          resetViewerEditPreview();
        }
      });
    });

    if (viewerEditVideoFile) {
      viewerEditVideoFile.addEventListener('change', () => {
        if (viewerEditVideoFileName) {
          viewerEditVideoFileName.textContent = viewerEditVideoFile.files[0] ? viewerEditVideoFile.files[0].name : 'æœªé€‰æ‹©æ–‡ä»¶';
        }
      });
    }

    if (viewerEditVideoUrlInput) {
      viewerEditVideoUrlInput.addEventListener('input', () => {
        if (getViewerEditVideoSource() === 'external') {
          const value = viewerEditVideoUrlInput.value.trim();
          const type = detectVideoType(value, 'url');
          showViewerEditPreview(type, value);
        }
      });
    }

    if (viewerEditBtn) viewerEditBtn.addEventListener('click', () => enterEditMode());
    if (viewerEditCancelBtn) viewerEditCancelBtn.addEventListener('click', () => {
      exitEditMode();
      if (currentViewerItem) renderViewerView(currentViewerItem);
    });
    if (viewerEditSubmitBtn) viewerEditSubmitBtn.addEventListener('click', submitViewerEdit);
    if (viewerCloseBtn) viewerCloseBtn.addEventListener('click', closeViewer);
    if (viewerClose2Btn) viewerClose2Btn.addEventListener('click', closeViewer);
    viewerModalEl?.addEventListener('click', (e)=>{ if(e.target.matches('[data-close]')) closeViewer(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && viewerModalEl?.classList.contains('is-open')) closeViewer(); });


    async function load(){
      skeleton();
      if (randomContainer) {
        randomContainer.innerHTML = '';
      }
      const p = new URLSearchParams();
      if (state.q) p.set('q', state.q);
      if (state.minRating) p.set('min_rating', state.minRating);
      if (state.videoOnly) p.set('has_video', '1');
      p.set('sort', state.sort);
      p.set('limit', '200');
      const resp = await fetch('/api/reviews/liked?' + p.toString());
      const data = await resp.json();
      if(!data.success){ grid.innerHTML = '<div class="muted">åŠ è½½å¤±è´¥</div>'; return; }
      const list = data.results || [];
      currentList = list;
      setCount(list.length);
      if(!list.length){
        grid.innerHTML = '<div class="muted">è¿˜æ²¡æœ‰å–œæ¬¢çš„è°±å­ï½ å»é¦–é¡µç‚¹ â¤ï¸ æ·»åŠ ä¸€æ¡å§ã€‚</div>';
        if (randomContainer) {
          randomContainer.innerHTML = '<div class="muted">å½“å‰æ²¡æœ‰å¯éšæœºçš„è°±å­ã€‚</div>';
        }
        return;
      }

      grid.innerHTML = '';
      list.forEach(item => {
        const card = createCardElement(item);
        grid.appendChild(card);
      });
    }

    // ç»‘å®šå·¥å…·æ 
    $('#refreshBtn').addEventListener('click', load);
    $('#qInput').addEventListener('input', (e)=>{ state.q = e.target.value.trim(); load(); });
    $('#videoOnly').addEventListener('change', (e)=>{ state.videoOnly = e.target.checked; load(); });
    $('#sortSelect').addEventListener('change', (e)=>{ state.sort = e.target.value; load(); });

    // è¯„åˆ† chip
    Array.from(document.querySelectorAll('#ratingChips .likes-chip')).forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('#ratingChips .likes-chip').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        state.minRating = parseInt(btn.dataset.val);
        load();
      });
    });

    randomBtn?.addEventListener('click', ()=>{
      if (!currentList.length) {
        if (randomContainer) {
          randomContainer.innerHTML = '<div class="muted">å½“å‰æ²¡æœ‰å¯éšæœºçš„è°±å­ã€‚</div>';
        }
        return;
      }
      const item = currentList[Math.floor(Math.random() * currentList.length)];
      copy(item.score_code);
      if (!randomContainer) { return; }
      randomContainer.innerHTML = '';
      const note = document.createElement('div');
      note.className = 'muted';
      note.textContent = `å·²å¤åˆ¶æ›²è°±ç  ${item.score_code}`;
      randomContainer.appendChild(note);
      const card = createCardElement(item, { extraClass: 'likes-card--sidebar' });
      randomContainer.appendChild(card);
    });

    // åˆå§‹åŠ è½½
    load();
  </script>
</body>
</html>
