# 功能实现计划

## 用户需求分析
1. 点击"获取鉴赏谱"按钮后，检查是否获取完成
2. 如果获取完成，按钮应变更为"新鉴赏码"按钮
3. 点击"新鉴赏码"按钮后，应将昨天最新的鉴赏曲库码文件中的所有码放到排除列表上
4. 然后自动发动查询

## 当前实现分析
- 前端：在`templates/batch_query.html`中有`fetchJianshangBtn`按钮，在`static/batch_query.js`中有相应的点击事件处理
- 后端：在`app.py`中有`/api/fetch_jianshang`接口处理获取鉴赏谱的逻辑，并将结果保存到`The old appreciation code/`目录下的文件中

## 需要实现的功能
1. 在前端JavaScript中，当获取鉴赏谱完成后，将按钮文本更改为"新鉴赏码"
2. 为"新鉴赏码"按钮添加点击事件处理程序，读取最新的鉴赏曲库码文件
3. 将文件中的码添加到排除列表
4. 自动触发查询操作

## 具体实现步骤

### 1. 修改前端JavaScript逻辑
文件：`static/batch_query.js`

需要修改`fetchJianshangBtn`的点击事件处理程序：
- 在获取鉴赏谱成功后，将按钮文本更改为"新鉴赏码"
- 为按钮添加新的点击事件处理程序，用于处理"新鉴赏码"按钮的逻辑

### 2. 修改后端Python逻辑
文件：`app.py`

需要添加一个新的API接口：
- 用于读取最新的鉴赏码文件
- 返回文件中的所有曲谱码

### 3. 实现新鉴赏码按钮点击事件处理程序
文件：`static/batch_query.js`

添加新的点击事件处理程序：
- 调用后端API获取最新的鉴赏码
- 将获取到的码添加到排除列表文本框中
- 自动触发查询操作

## 代码修改详情

### 前端修改 (`static/batch_query.js`)
1. 修改`fetchJianshangBtn`的点击事件处理程序
2. 添加新的函数处理"新鉴赏码"按钮点击事件

### 后端修改 (`app.py`)
1. 添加新的API接口`/api/latest_jianshang_codes`用于获取最新的鉴赏码

## 测试计划
1. 点击"获取鉴赏谱"按钮，验证是否能成功获取并显示曲谱码
2. 验证按钮是否成功变更为"新鉴赏码"
3. 点击"新鉴赏码"按钮，验证是否能将最新的鉴赏码添加到排除列表
4. 验证是否能自动触发查询操作